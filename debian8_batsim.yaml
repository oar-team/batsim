#==============================================================================
# vim: softtabstop=2 shiftwidth=2 expandtab fenc=utf-8 cc=81 tw=80
#==============================================================================
#
# DESCRIPTION: An applicance for batsim experimentation
#
#==============================================================================

---
## Choose one of them the following extends

# Checkpoint only with btrfs
#checkpoint: btrfs.yaml
#extend: default/chroot/debian8.yaml

extend: default/virtualbox/debian8.yaml

#extend: default/qemu/debian8.yaml

global:
  btrfs_volume: "/"
  virtualbox_memory_size: 2048
  qemu_memory_size : 2048
  appliance_formats: tar.gz
  appliance_tar_compression_level: fast
  setup_packages: git cmake build-essential e2fsprogs $$setup_packages
  default_keyboard_layout: fr
  default_timezone: Europe/Paris
  root_password: root
  hostname: batsim
  simctn_dir: /root

  simgrid_commit: 20e851bd58a0b31
  batsim_commit: cb114a9054e6
  locality_sched_commit: 12df12a
  oar_commit: 2c7c4df


bootstrap:
  - "@base"

setup:
  #
  # General configuration
  #
  - "@base"
  - enable_root_ssh_login

  #
  # Simulator and schedulers install
  #
  - simgrid_install:
    - commit_hash: $$simgrid_commit
  - locality_scheduler:
    - commit_hash: $$locality_sched_commit
  - oar_sched:
    - install dependencies:
      - exec_in: apt-get -y --force-yes install python3-pip 2>&1
    - install_oar3:
      - exec_in: |
          cd $$simctn_dir
          git clone https://github.com/oar-team/oar3.git
      - exec_in: |
          cd $$simctn_dir/oar3
          git checkout $$oar_commit
          pip3 install -e .
  - batsim_install:
    - install dependencies:
      - exec_in: |
          apt-get -y --force-yes install \
          libboost-filesystem-dev \
          libboost-system-dev 2>&1
      # Install rapidjson (not available in jessy)
      - exec_in: |
          cd $$simctn_dir
          git clone https://github.com/miloyip/rapidjson.git
      - exec_in: |
          cd $$simctn_dir/rapidjson
          git checkout 3d5848a # v1.02
          cp -a include/rapidjson /usr/include
    - do_it:
      - exec_in: |
          cd $$simctn_dir
          git clone https://scm.gforge.inria.fr/anonscm/git/batsim/batsim.git
      - exec_in: |
          cd $$simctn_dir/batsim
          git checkout $$batsim_commit
          mkdir build
      - exec_in: |
          cd $$simctn_dir/batsim/build
          cmake ..
          make -j$(nproc)
          make install

  #
  # Visualization tools
  #
  - VITE_install:
    - install dependencies:
      - exec_in: apt-get -y --force-yes install vite 2>&1
      #- get_sources:
      #- - exec_in: |
      #-     cd $$simctn_dir
      #-     svn checkout svn://scm.gforge.inria.fr/svnroot/vite/
      #- install_it:
      #- - exec_in: |
      #-     cd $$simctn_dir/vite/trunk
      #-     mkdir build
      #-     cd build
      #-     cmake ..
      #-     make -j$(nproc)
      #-     make install

  - evalys:
    - install dependencies:
      - exec_in: |
          apt-get -y --force-yes install \
            python3-pip \
            python3-pyqt4 \
            python3-matplotlib \
            python3-pandas \
            ipython3-notebook \
            python3-mpld3
    - install_evalys:
      - exec_in: |
          cd $$simctn_dir
          git clone https://github.com/oar-team/evalys.git
      - exec_in: |
          cd $$simctn_dir/evalys
          pip3 install .

  # Evironement capture and sharing for runtime extraction
  #
  - reprozip

  # Experiment inputs and launch scripts
  #
  - import_batsim_experiment_tools:
    - expe_batsim_home: $$simctn_dir

  # Personal customization
  #

  # Import my personal dev tools
  #- my_dev_tools
  # set the dev git repository instead of the Read-Only ones
  #- set_dev_git_repo

export:
  - "@base"
