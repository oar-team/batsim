# This script should be called from Batsim's root directory

# If needed, the working directory of this script can be specified within this file
#base_working_directory: ~/proj/batsim

# If needed, the output directory of this script can be specified within this file
base_output_directory: /tmp/batsim_tests/smpi

base_variables:
  batsim_dir: ${base_working_directory}

implicit_instances:
  implicit:
    sweep:
      platform :
        - {"name":"small", "filename":"${batsim_dir}/platforms/small_platform.xml"}
      workload :
        - {"name":"compute", "filename":"${batsim_dir}/workload_profiles/test_smpi_compute_only.json"}
        - {"name":"mixed", "filename":"${batsim_dir}/workload_profiles/test_smpi_mixed_comp_comm.json"}
      pybatsim_algo:
        - {"name":"filler", "algo_name":"fillerSched"}
    generic_instance:
      timeout: 10
      working_directory: ${base_working_directory}
      output_directory: ${base_output_directory}/results/${pybatsim_algo[name]}_${workload[name]}_${platform[name]}
      batsim_command: batsim -p ${platform[filename]} -w ${workload[filename]} -e ${output_directory}/out -s ${output_directory}/socket -L
      sched_command: python2 ${batsim_dir}schedulers/pybatsim/launcher.py ${pybatsim_algo[algo_name]} -s ${output_directory}/socket

commands_before_instances:
  - |
      #!/usr/bin/python2
      # Let's check that the base working directory looks like Batsim's
      import os
      import sys

      bwd = os.environ['base_working_directory']

      if os.path.isdir(bwd):
          dirs = [bwd + '/' + x for x in ['cmake', 'platforms', 'schedulers',
                                          'src', 'tools']]
          for dir in dirs:
              if not os.path.isdir(dir):
                  print('The base working directory seems to be bad: there is '
                        "no '{}' directory.", dir)
                  sys.exit(1)
          sys.exit(0)
      else:
          print("The base working directory does not exist!")
          sys.exit(2)

  - |
      #!/usr/bin/python2
      # Let's clean the output directory if needed
      import os
      import shutil
      import sys

      bod = os.environ['base_output_directory']

      if os.path.isdir(bod):
          dirs = [bod + '/' + x for x in ['instances', 'sweeper', 'results']]
          for dir in dirs:
              if os.path.isdir(dir):
                  shutil.rmtree(dir)

      sys.exit(0)
